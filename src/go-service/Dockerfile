FROM golang:1.20.1 as builder

ENV PYTHON_SERVICE_HOST=0.0.0.0
ENV PYTHON_SERVICE_PORT="30000"
ENV JAVA_SERVICE_HOST=0.0.0.0
ENV JAVA_SERVICE_PORT="30001"
ENV GO_SERVICE_HOST=0.0.0.0
ENV GO_SERVICE_PORT="30002"
ENV DB_SERVICE_HOST=0.0.0.0
ENV DB_SERVICE_PORT="5432"
ENV KAFKA_SERVICE_HOST=0.0.0.0
ENV KAFKA_SERVICE_PORT="9092"
ENV KAFKA_SERVICE_TOPIC=test
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=mysecretpassword
ENV DB_SERVICE_NAME=numbers

WORKDIR /app

COPY . ./
RUN go mod download

RUN GO111MODULE=on CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o go-service


FROM alpine:latest

ENV PYTHON_SERVICE_HOST=0.0.0.0
ENV PYTHON_SERVICE_PORT="30000"
ENV JAVA_SERVICE_HOST=0.0.0.0
ENV JAVA_SERVICE_PORT="30001"
ENV GO_SERVICE_HOST=0.0.0.0
ENV GO_SERVICE_PORT="30002"
ENV DB_SERVICE_HOST=0.0.0.0
ENV DB_SERVICE_PORT="5432"
ENV KAFKA_SERVICE_HOST=0.0.0.0
ENV KAFKA_SERVICE_PORT="9092"
ENV KAFKA_SERVICE_TOPIC=test
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=mysecretpassword
ENV DB_SERVICE_NAME=numbers

RUN apk --no-cache add ca-certificates

WORKDIR /root/

COPY --from=builder /app/go-service .

EXPOSE 30002

ENTRYPOINT ["./go-service"]